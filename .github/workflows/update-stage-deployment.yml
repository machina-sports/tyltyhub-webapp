name: Update Stage Deployment

on:
  workflow_dispatch:

env:
  NAMESPACE: tenant-entain-organization
  AKS_CLUSTER_NAME: mks-community-cluster
  AKS_RESOURCE_GROUP: mks-community-group

jobs:
  update-image:
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS Credentials
        uses: azure/aks-set-context@v3
        with:
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Update Deployment Image
        run: |
          # Update the deployment image
          kubectl set image deployment/sportingbet-cwc \
            ${{ env.NAMESPACE }}-sportingbet-cwc=${{ secrets.REGISTRY_URL }}/machina-sportingbet-cwc:latest \
            -n ${{ env.NAMESPACE }}
          
          # Wait for rollout with increased timeout
          kubectl rollout status deployment/sportingbet-cwc -n ${{ env.NAMESPACE }} --timeout=300s
          
          # If rollout fails, get debugging information
          if [ $? -ne 0 ]; then
            echo "Deployment failed. Gathering debug information..."
            kubectl describe deployment sportingbet-cwc -n ${{ env.NAMESPACE }}
            kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.NAMESPACE }}-sportingbet-cwc
            kubectl describe pods -n ${{ env.NAMESPACE }} -l app=${{ env.NAMESPACE }}-sportingbet-cwc
            exit 1
          fi

      # - name: Notify Slack - Update Success
      #   uses: rtCamp/action-slack-notify@v2
      #   env:
      #     SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      #     SLACK_CHANNEL: your-slack-channel
      #     SLACK_USERNAME: GitHub Actions
      #     SLACK_COLOR: 'good'
      #     SLACK_TITLE: 'Stage Deployment Update Successful'
      #     SLACK_MESSAGE: 'Updated stage deployment to latest image successfully.'
      #     SLACK_ICON: ':heavy_check_mark:'
      #   if: success()

      # - name: Notify Slack - Update Failed
      #   uses: rtCamp/action-slack-notify@v2
      #   env:
      #     SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
      #     SLACK_CHANNEL: your-slack-channel
      #     SLACK_USERNAME: GitHub Actions
      #     SLACK_COLOR: 'danger'
      #     SLACK_TITLE: 'Stage Deployment Update Failed'
      #     SLACK_MESSAGE: 'Failed to update stage deployment image. Check the action logs for details.'
      #     SLACK_ICON: ':x:'
      #   if: failure()
