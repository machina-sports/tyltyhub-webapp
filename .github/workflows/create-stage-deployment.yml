name: Create Stage Deployment

on:
  workflow_dispatch:

env:
  NAMESPACE: tenant-entain-organization
  DOMAIN: org.machina.gg
  AKS_CLUSTER_NAME: mks-community-cluster
  AKS_RESOURCE_GROUP: mks-community-group

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS Credentials
        uses: azure/aks-set-context@v3
        with:
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Create namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Create Certificate
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: cert-manager.io/v1
          kind: Certificate
          metadata:
            name: ${{ env.NAMESPACE }}-cert
            namespace: ${{ env.NAMESPACE }}
          spec:
            secretName: ${{ env.NAMESPACE }}-tls
            dnsNames:
            - cwc-staging-entain-organization.${{ env.DOMAIN }}
            issuerRef:
              name: letsencrypt-prod
              kind: ClusterIssuer
          EOF

      - name: Create Deployment
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: sportingbet-cwc
            namespace: ${{ env.NAMESPACE }}
          spec:
            progressDeadlineSeconds: 600
            replicas: 1
            selector:
              matchLabels:
                app: ${{ env.NAMESPACE }}-sportingbet-cwc
            template:
              metadata:
                labels:
                  app: ${{ env.NAMESPACE }}-sportingbet-cwc
              spec:
                imagePullSecrets:
                  - name: dockerhub-secret
                schedulerName: default-scheduler
                tolerations:
                  - key: user
                    operator: Exists
                    effect: NoSchedule
                volumes:
                - name: machina-core-keys-volume
                  secret:
                    secretName: machina-core-key
                    defaultMode: 420
                containers:
                - name: ${{ env.NAMESPACE }}-sportingbet-cwc
                  image: ${{ secrets.REGISTRY_URL }}/sportingbet-cwc:latest
                  volumeMounts:
                  - name: machina-core-keys-volume
                    mountPath: /app/keys
                    readOnly: true
                  ports:
                  - containerPort: 3000
                  readinessProbe:
                    httpGet:
                      path: /
                      port: 3000
                    initialDelaySeconds: 10
                    periodSeconds: 5
                  livenessProbe:
                    httpGet:
                      path: /
                      port: 3000
                    initialDelaySeconds: 15
                    periodSeconds: 10
                  resources:
                    requests:
                      memory: "256Mi"
                      cpu: "100m"
                    limits:
                      memory: "512Mi"
                      cpu: "200m"
          EOF

      - name: Create Service
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Service
          metadata:
            name: ${{ env.NAMESPACE }}-sportingbet-cwc
            namespace: ${{ env.NAMESPACE }}
          spec:
            selector:
              app: ${{ env.NAMESPACE }}-sportingbet-cwc
            ports:
            - port: 80
              targetPort: 3000
          EOF

      - name: Create Ingress
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: ${{ env.NAMESPACE }}-ingress-sportingbet-cwc
            namespace: ${{ env.NAMESPACE }}
            annotations:
              kubernetes.io/ingress.class: nginx
              nginx.ingress.kubernetes.io/ssl-redirect: "true"
              cert-manager.io/cluster-issuer: "letsencrypt-prod"
              nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
              nginx.ingress.kubernetes.io/proxy-body-size: "50m"
              nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
              nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
          spec:
            rules:
            - host: cwc-staging-entain-organization.${{ env.DOMAIN }}
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: ${{ env.NAMESPACE }}-sportingbet-cwc
                      port:
                        number: 80
            tls:
            - hosts:
              - cwc-staging-entain-organization.${{ env.DOMAIN }}
              secretName: ${{ env.NAMESPACE }}-tls
          EOF
