name: Update Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - development
          - production
      tag:
        description: 'Image tag to deploy (e.g. latest, develop, v1.0.0)'
        required: true
        type: string
        default: 'latest'

env:
  NAMESPACE: tenant-entain-organization
  AKS_CLUSTER_NAME: mks-community-cluster
  AKS_RESOURCE_GROUP: mks-community-group
  ENV_PREFIX: ${{ github.event.inputs.environment }}

jobs:
  update-image:
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS Credentials
        uses: azure/aks-set-context@v3
        with:
          cluster-name: ${{ env.AKS_CLUSTER_NAME }}
          resource-group: ${{ env.AKS_RESOURCE_GROUP }}

      - name: Login to Docker Hub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Update Deployment Image
        run: |
          # Update the deployment image
          kubectl set image deployment/sportingbet-cwc-${{ env.ENV_PREFIX }} \
            ${{ env.NAMESPACE }}-sportingbet-cwc=${{ secrets.REGISTRY_URL }}/sportingbet-cwc:${{ github.event.inputs.tag }} \
            -n ${{ env.NAMESPACE }}
          
          # Wait for rollout with increased timeout
          kubectl rollout status deployment/sportingbet-cwc-${{ env.ENV_PREFIX }} -n ${{ env.NAMESPACE }} --timeout=300s
          
          # If rollout fails, get debugging information
          if [ $? -ne 0 ]; then
            echo "Deployment failed. Gathering debug information..."
            kubectl describe deployment sportingbet-cwc-${{ env.ENV_PREFIX }} -n ${{ env.NAMESPACE }}
            kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.NAMESPACE }}-sportingbet-cwc-${{ env.ENV_PREFIX }}
            kubectl describe pods -n ${{ env.NAMESPACE }} -l app=${{ env.NAMESPACE }}-sportingbet-cwc-${{ env.ENV_PREFIX }}
            exit 1
          fi

      - name: Notify Slack - Update Success
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: your-slack-channel
          SLACK_USERNAME: GitHub Actions
          SLACK_COLOR: 'good'
          SLACK_TITLE: '${{ github.event.inputs.environment }} Deployment Update Successful'
          SLACK_MESSAGE: 'Updated ${{ github.event.inputs.environment }} deployment to ${{ github.event.inputs.tag }} image successfully.'
          SLACK_ICON: ':heavy_check_mark:'
        if: success()

      - name: Notify Slack - Update Failed
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_CHANNEL: your-slack-channel
          SLACK_USERNAME: GitHub Actions
          SLACK_COLOR: 'danger'
          SLACK_TITLE: '${{ github.event.inputs.environment }} Deployment Update Failed'
          SLACK_MESSAGE: 'Failed to update ${{ github.event.inputs.environment }} deployment to ${{ github.event.inputs.tag }} image. Check the action logs for details.'
          SLACK_ICON: ':x:'
        if: failure()
